---
- name: Bootstrap hosts for Ansible management
  hosts: all
  become: yes
  vars:
    ansible_ssh_public_keys: []
    # Example: ansible_ssh_public_keys:
    #   - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC..."
    #   - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI..."
    # Or use ansible_ssh_public_key_file to specify a file path
    ansible_ssh_public_key_file: "~/.ssh/id_rsa.pub"  # Path to public key file on control node
    ansible_sudo_nopasswd: true

  tasks:
    - name: Get user home directory
      command: getent passwd "{{ ansible_user }}" | cut -d: -f6
      register: user_home_cmd
      changed_when: false
      failed_when: false

    - name: Set user home directory
      set_fact:
        user_home: "{{ user_home_cmd.stdout | trim }}"
      when: user_home_cmd.rc == 0 and user_home_cmd.stdout | length > 0

    - name: Set user home directory (fallback)
      set_fact:
        user_home: "{{ '/root' if ansible_user == 'root' else '/home/' + ansible_user }}"
      when: user_home is not defined

    - name: Get user group
      command: id -gn "{{ ansible_user }}"
      register: user_group_cmd
      changed_when: false

    - name: Set user group
      set_fact:
        user_group: "{{ user_group_cmd.stdout | trim }}"
      when: user_group_cmd.rc == 0

    - name: Ensure user home directory exists
      file:
        path: "{{ user_home }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ user_group }}"
        mode: '0755'

    - name: Create .ssh directory for current user
      file:
        path: "{{ user_home }}/.ssh"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ user_group }}"
        mode: '0700'

    - name: Read SSH public key from file (if file specified)
      slurp:
        src: "{{ ansible_ssh_public_key_file | expanduser }}"
      register: ssh_public_key_content
      when: ansible_ssh_public_key_file is defined and ansible_ssh_public_key_file | length > 0
      delegate_to: localhost
      run_once: true
      failed_when: false
      changed_when: false

    - name: Set SSH public keys from file
      set_fact:
        ansible_ssh_public_keys: "{{ ansible_ssh_public_keys + [ssh_public_key_content.content | b64decode | trim] }}"
      when:
        - ansible_ssh_public_key_file is defined
        - ansible_ssh_public_key_file | length > 0
        - ssh_public_key_content.content is defined
        - ssh_public_key_content.content | length > 0

    - name: Add SSH authorized keys
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ item }}"
        exclusive: false
      loop: "{{ ansible_ssh_public_keys }}"
      when: ansible_ssh_public_keys | length > 0

    - name: Set correct permissions on authorized_keys file
      file:
        path: "{{ user_home }}/.ssh/authorized_keys"
        owner: "{{ ansible_user }}"
        group: "{{ user_group }}"
        mode: '0600'
      when: ansible_ssh_public_keys | length > 0

    - name: Install sudo package (Debian/Ubuntu)
      apt:
        name: sudo
        state: present
        update_cache: yes
      when: ansible_pkg_mgr == 'apt'

    - name: Install sudo package (RHEL/CentOS)
      yum:
        name: sudo
        state: present
      when: ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf'

    - name: Check if sudoers file entry exists for current user
      lineinfile:
        path: "/etc/sudoers.d/{{ ansible_user }}"
        regexp: '^{{ ansible_user }}'
        state: absent
      check_mode: yes
      register: sudoers_check
      changed_when: false
      failed_when: false

    - name: Create sudoers file for current user (nopasswd)
      lineinfile:
        path: "/etc/sudoers.d/{{ ansible_user }}"
        line: "{{ ansible_user }} ALL=(ALL) NOPASSWD: ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      when: ansible_sudo_nopasswd | bool

    - name: Create sudoers file for current user (with password)
      lineinfile:
        path: "/etc/sudoers.d/{{ ansible_user }}"
        line: "{{ ansible_user }} ALL=(ALL) ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      when: not (ansible_sudo_nopasswd | bool)

    - name: Ensure sudoers.d directory has correct permissions
      file:
        path: /etc/sudoers.d
        state: directory
        mode: '0755'

    - name: Verify sudo configuration
      command: visudo -c
      changed_when: false
      failed_when: false

    - name: Display bootstrap completion message
      debug:
        msg:
          - "Bootstrap completed successfully!"
          - "SSH keys have been configured for user '{{ ansible_user }}'"
          - "Sudo access has been configured for user '{{ ansible_user }}'"
          - "User '{{ ansible_user }}' is ready for Ansible management"

